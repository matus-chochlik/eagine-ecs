#!/bin/bash
#
source "$(dirname ${0})/build-pkg-cfg"
src_dir=$(realpath "@SRC_DIR@")
bin_dir=$(realpath "@BIN_DIR@")
pkg_dir=$(realpath "@PKG_DIR@")

mkdir -p "${pkg_dir}/usr"
pkg_prefix=$(realpath "@PKG_DIR@/usr")
lib_prefix="${pkg_prefix}/lib/@PKG_MULTIARCH@"
cmk_prefix="${lib_prefix}/cmake/EAGine"

mkdir -p "${pkg_dir}/DEBIAN"
mkdir -p "${pkg_prefix}/include"
mkdir -p "${lib_prefix}/eagine"
mkdir -p "${cmk_prefix}"

# ------------------------------------------------------------------------------
cp "${eagine_ecs_path}" \
   "${lib_prefix}/eagine/${eagine_ecs_name}"
# ------------------------------------------------------------------------------
cat "$(dirname ${0})/pkg-headers.txt" |\
tr ';' '\n' |\
while read abs_path
do
	rel_path=${abs_path#$(realpath "${src_dir}/include")/}
	mkdir -p $(dirname "${pkg_prefix}/include/${rel_path}")
	cp "${abs_path}" \
	   "${pkg_prefix}/include/${rel_path}"
done
# ------------------------------------------------------------------------------
mkdir -p "${cmk_prefix}"
cat << EOD > "${cmk_prefix}/EAGineECSConfig.cmake"
if(CMAKE_VERSION VERSION_LESS 3.16.0)
  message(
    FATAL_ERROR
    "This file relies on consumers using CMake 3.16.0 or greater."
  )
endif()

get_filename_component(_IMPORT_PREFIX "\${CMAKE_CURRENT_LIST_FILE}" PATH)
get_filename_component(_IMPORT_PREFIX "\${_IMPORT_PREFIX}" PATH)
get_filename_component(_IMPORT_PREFIX "\${_IMPORT_PREFIX}" PATH)
get_filename_component(_IMPORT_PREFIX "\${_IMPORT_PREFIX}" PATH)
get_filename_component(_IMPORT_PREFIX "\${_IMPORT_PREFIX}" PATH)
if(_IMPORT_PREFIX STREQUAL "/")
  set(_IMPORT_PREFIX "")
endif()

add_library(EAGine::ECS INTERFACE IMPORTED)

target_compile_definitions(
  EAGine::ECS INTERFACE EAGINE_ECS_LIBRARY=1
)

set_target_properties(
  EAGine::ECS PROPERTIES
  INTERFACE_INCLUDE_DIRECTORIES "\${_IMPORT_PREFIX}/include"
)
set_target_properties(
  EAGine::ECS PROPERTIES
  INTERFACE_LINK_DIRECTORIES "\${_IMPORT_PREFIX}/lib/@PKG_MULTIARCH@/eagine"
)

target_link_libraries(
  EAGine::ECS
  INTERFACE
    "\${_IMPORT_PREFIX}/lib/@PKG_MULTIARCH@/eagine/${eagine_ecs_name}"
  	EAGine::Core
)
EOD
# ------------------------------------------------------------------------------
cat << EOD > "${cmk_prefix}/EAGineECSDeps.cmake"
set(EAGineECSDeps Core)
EOD
# ------------------------------------------------------------------------------
mkdir -p "${pkg_dir}/DEBIAN"
cat << EOD > "${pkg_dir}/DEBIAN/control"
Package: eagine-ecs-dev
Version: @PKG_VERSION@
Architecture: @PKG_ARCH@
Installed-Size: $(du -k -s ${pkg_dir} | cut -f1)
Depends: eagine-core-dev
Maintainer: Matus Chochlik <chochlik@gmail.com>
Description: Message bus for distributed C++ applications.
EOD
